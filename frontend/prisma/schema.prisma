// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String   
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs      Log[]
}

model Log {
  id        String   @id @default(cuid())
  action    String   
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  timestamp DateTime @default(now())
}

model Goal {
  id           String   @id @default(uuid())
  category     String   
  metric       String   
  label        String   
  value        Float    
  month        String   
  filter_group String?  
  updatedAt    DateTime @updatedAt
  @@unique([metric, month])
}

// TABELA FINANCEIRA (Origem: Scraper - worker_faturamento_scraping.py)
// Contém apenas o que foi faturado/pago.
model FaturamentoAnalitico {
  hash_id        String   @id
  unidade        String
  grupo          String?  
  procedimento   String?
  total_pago     Float?   @map("total_pago")
  data_pagamento String?  @map("data_do_pagamento") // DD/MM/YYYY
  data_ref       String?  @map("data_de_referência")
  paciente       String?
  updated_at     String
  
  @@map("faturamento_analitico")
}

// TABELA DE AGENDAMENTOS (Origem: API - worker_feegow.py)
// Contém status futuros e não faturados.
model FeegowAppointment {
  appointment_id    Int      @id
  date              String   // YYYY-MM-DD
  status_id         Int
  value             Float
  specialty         String?
  professional_name String?
  procedure_group   String?
  updated_at        DateTime @default(now())

  @@map("feegow_appointments")
}

// Configurações de metas salvas pelo painel
model GoalsConfig {
  id            Int     @id @default(autoincrement())
  name          String
  scope         String
  sector        String
  start_date    String
  end_date      String
  periodicity   String
  target_value  Float
  unit          String
  linked_kpi_id String?
  filter_group  String?   // Filtro avançado (Ex: Consultas, Exames)
  clinic_unit   String?   // Unidade clínica (Ex: Matriz, Filial)
  collaborator  String?   // Colaborador específico
  team          String?   // Equipe/setor responsável pela meta
  created_at    String?
  updated_at    String?

  @@map("goals_config")
}

// TABELA DE EQUIPES (Teams Master)
// Define as equipes/setores que podem ser alvo de metas
// Criadas e gerenciadas pela página de metas
model Team {
  id        String   @id @default(cuid())
  name      String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  users     UserTeam[]

  @@map("teams_master")
}

// TABELA DE RELACIONAMENTO USUÁRIO-EQUIPE (Many-to-Many)
// Um usuário pode fazer parte de múltiplas equipes
// Atualizado no modal 'Equipes' da página de produtividade
model UserTeam {
  id        String   @id @default(cuid())
  user_name String
  team_id   String
  team      Team     @relation(fields: [team_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([user_name, team_id])
  @@map("user_teams")
}